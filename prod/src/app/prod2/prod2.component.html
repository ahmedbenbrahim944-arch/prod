<div class="full-screen-layout text-white relative overflow-hidden">
  <!-- Background avec particules -->
  <div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-10"
       style="background-image: url('https://www.tannerag.ch/Marketing/News%20and%20Social%20Media/38748/image-thumb__38748__contentImageLarge/production-process.e47f5cea.jpg')">
  </div>

  <!-- SystÃ¨me de particules -->
  <div class="absolute inset-0 pointer-events-none overflow-hidden">
    <div *ngFor="let particle of particles()" 
         class="particle absolute rounded-full bg-cyan-400/40"
         [style.left]="particle.left"
         [style.animation-delay]="particle.animationDelay"
         [style.width]="particle.size"
         [style.height]="particle.size"
         [style.opacity]="particle.opacity">
    </div>
  </div>

  <div class="relative z-10 h-screen flex flex-col">
    <!-- Header principal -->
    <header class="header-industrial py-3 px-4 sm:px-6">
      <div class="flex justify-between items-center">
        <button 
          (click)="goBackToLogin()"
          class="px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-red-600 hover:bg-red-500 text-white flex items-center text-xs sm:text-sm">
          <svg class="w-4 h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span class="hidden sm:inline">Retour</span>
        </button>

        <div class="text-center flex-1">
          <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-cyan-400">PLANIFICATION DES LIGNES</h1>
        </div>
        

        <div class="w-16 sm:w-32"></div>
      </div>
    </header>

    <!-- Contenu principal -->
    <div class="flex-1 flex overflow-hidden">
      
      <!-- Affichage des lignes de production -->
      <div *ngIf="!selectedLigne()" class="flex-1 p-2 sm:p-4 overflow-auto">
        <div class="max-w-[95%] mx-auto">
          
          <!-- Barre de recherche -->
          <div class="mb-4 sm:mb-6 flex justify-center">
            <div class="search-container p-2 sm:p-3 rounded-lg w-full max-w-md sm:w-96">
              <div class="flex items-center">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 search-icon mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input 
                  type="text" 
                  [value]="searchLineQuery()"
                  (input)="onSearchLineChange($event)"
                  placeholder="Rechercher une ligne..." 
                  class="search-input flex-1 text-sm sm:text-base">
                <button 
                  *ngIf="searchLineQuery()"
                  (click)="clearLineSearch()"
                  class="ml-2 text-gray-400 hover:text-white transition-colors">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="filteredLines().length === 0" class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-base sm:text-lg">Aucune ligne trouvÃ©e</p>
          </div>

          <!-- Grille responsive -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            <div *ngFor="let line of filteredLines()" 
                 (click)="onLigneSelected(line)"
                 class="line-card-large cursor-pointer">
              <div class="image-container-large">
                <img [src]="line.imageUrl" [alt]="line.ligne">
                <div class="line-overlay-large">
                  <div class="line-name-large">{{ line.ligne }}</div>
                  <div class="text-cyan-200 text-xs sm:text-sm mt-2">{{ line.referenceCount }} rÃ©fÃ©rences</div>
                </div>
                <div [class.status-badge-active]="line.isActive" 
                     [class.status-badge-inactive]="!line.isActive"
                     class="status-badge">
                  {{ line.isActive ? 'Active' : 'Inactive' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Affichage de la planification -->
      <div *ngIf="selectedLigne() && !selectedReferenceDetails()" class="flex-1 flex relative">
        
      

        <!-- Sidebar des semaines -->
         <button 
          *ngIf="selectedLigne()"
          (click)="toggleSidebar()"
          class="fixed left-4 top-24 z-50 p-3 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white transition-all duration-300 shadow-lg lg:hidden">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path *ngIf="!sidebarVisible()" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            <path *ngIf="sidebarVisible()" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- Sidebar des semaines -->
        <div 
          [class.translate-x-0]="sidebarVisible()"
          [class.-translate-x-full]="!sidebarVisible()"
          class="weeks-sidebar fixed lg:relative left-0 top-0 h-full w-80 overflow-y-auto custom-scrollbar transition-transform duration-300 ease-in-out z-40 lg:translate-x-0">
    
          <div class="p-3 sm:p-4">
            <!-- En-tÃªte du sidebar -->
            <div class="flex justify-between items-center mb-4 sm:mb-6">
              <button 
                (click)="backToLines()"
                class="px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gray-700 hover:bg-gray-600 text-white flex items-center text-xs sm:text-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Retour aux lignes
              </button>
              
              <!-- Bouton fermer sidebar (mobile uniquement) -->
              <button 
                (click)="toggleSidebar()"
                class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white transition-colors lg:hidden">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-cyan-900/20 rounded-lg border border-cyan-700/30">
              <h3 class="font-bold text-cyan-400 text-lg sm:text-xl mb-2">{{ selectedLigne()!.ligne }}</h3>
              <p class="text-gray-300 text-xs sm:text-sm">{{ selectedLigne()!.referenceCount }} rÃ©fÃ©rences disponibles</p>
            </div>

            <h4 class="text-cyan-300 font-semibold mb-3 sm:mb-4 text-xs sm:text-sm uppercase tracking-wider">Semaines disponibles</h4>
            <div class="space-y-2">
              <div *ngFor="let week of getAvailableWeeks()" 
                   (click)="onWeekSelected(week.number)"
                   [class.active]="selectedWeek() === week.number"
                   class="week-item p-2 sm:p-3 rounded-lg cursor-pointer border border-gray-600/30">
                <div class="font-bold text-white text-base sm:text-lg">Semaine {{ week.number }}</div>
                <div class="text-gray-400 text-xs mt-1">{{ week.startDate | date:'dd/MM' }} - {{ week.endDate | date:'dd/MM' }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Overlay pour fermer sidebar (mobile/tablette uniquement) -->
        <div 
          *ngIf="sidebarVisible()" 
          (click)="closeSidebarOverlay()"
          class="fixed inset-0 bg-black/50 z-30 lg:hidden">
        </div>

        <!-- Contenu de la semaine -->
        <div class="flex-1 p-3 sm:p-4 md:p-6 overflow-auto custom-scrollbar">
          <div *ngIf="weekPlanification()" class="mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
              <div>
                <h2 class="text-xl sm:text-2xl font-bold text-cyan-400 mb-2">
                  {{ selectedLigne()!.ligne }} - Semaine {{ selectedWeek() }}
                </h2>
                <p class="text-gray-400 text-sm sm:text-base">{{ filteredWeekPlanification()!.startDate | date:'dd/MM/yyyy' }} au {{ filteredWeekPlanification()!.endDate | date:'dd/MM/yyyy' }}</p>
              </div>
              
              <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:space-x-4">
                <div class="search-container p-2 sm:p-3 rounded-lg w-full sm:w-64">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 search-icon mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input 
                      type="text" 
                      [value]="searchReferenceQuery()"
                      (input)="onSearchReferenceChange($event)"
                      placeholder="Rechercher rÃ©fÃ©rence..." 
                      class="search-input flex-1 text-sm sm:text-base">
                    <button 
                      *ngIf="searchReferenceQuery()"
                      (click)="clearReferenceSearch()"
                      class="ml-2 text-gray-400 hover:text-white transition-colors">
                      <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <button 
                  (click)="toggleEditMode()"
                  [class.bg-green-600]="!isEditing()"
                  [class.bg-blue-600]="isEditing()"
                  class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-all duration-300 text-white flex items-center justify-center text-sm sm:text-base">
                  <svg *ngIf="!isEditing()" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  <svg *ngIf="isEditing()" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  {{ isEditing() ? 'Enregistrer' : 'Modifier' }}
                </button>
              </div>
            </div>
          </div>
 <!-- LÃ©gende simple -->
          <div class="mb-3 text-xs text-gray-400">
            <div class="flex flex-wrap gap-x-4 gap-y-1">
              <span><strong class="text-cyan-400">C:</strong> Commander</span>
              <span><strong class="text-cyan-400">M:</strong> Modifier</span>
              <span><strong class="text-cyan-400">DP:</strong> DÃ©claration production</span>
              <span><strong class="text-cyan-400">DM:</strong> DÃ©claration Magasin</span>
              <span><strong class="text-cyan-400">Î”:</strong> Delta</span>
              <span><strong class="text-cyan-400">NB OP:</strong> Nombre d'opÃ©rateurs</span>
            </div>
          </div>

          <!-- Tableau de planification -->
          <div *ngIf="filteredWeekPlanification()" 
               class="table-responsive-container rounded-xl border-2 border-gray-700 bg-slate-900/60 shadow-2xl"
               #tableContainer
               [class.scrollable]="isScrollable()"
               [class.scrolled]="isScrolled()"
               [class.scrolled-end]="isScrolledEnd()"
               [class.scrolled-start]="!isScrolled()">
            
            <div class="table-scroll-wrapper" 
                 #scrollWrapper
                 (scroll)="onTableScroll($event)"
                 (touchstart)="onTouchStart($event)"
                 (touchmove)="onTouchMove($event)"
                 (touchend)="onTouchEnd()">
              
              <div class="planning-table-min-width">
                <table class="week-planning-table w-full">
                 <!-- Remplacer la section <thead> du tableau par ceci : -->
<!-- Version avec possibilitÃ© d'Ã©diter le NB OP -->
<thead>
  <tr>
    <th class="sticky left-0 z-20 sticky-cell border-2 border-gray-700" rowspan="2">RÃ‰FÃ‰RENCES</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">C/R</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">OF</th>
    
    <ng-container *ngFor="let day of weekDays; let i = index">
      <th class="text-center border-2 border-gray-700 day-header" colspan="1">
  <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
    <div class="text-center">
      <div class="font-bold text-cyan-400 capitalize text-sm sm:text-base">{{ day }}</div>
      <!-- CHANGER text-gray-300 EN text-black -->
      <div class="text-xs sm:text-sm text-black mt-1">{{ getDayDateCorrected(weekDays[i], i) | date:'dd/MM' }}</div>
    </div>
     <button 
            (click)="onPersonIconClick(day)"
            class="ml-2 p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors"
            title="Saisie rapport production">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </button>
  </div>
</th>
    </ng-container>
  </tr>
  <tr>
    <ng-container *ngFor="let day of weekDays">
      <th class="text-center border-2 border-gray-700 day-header">
        <div class="flex flex-col items-center justify-center px-2 py-2">
          <!-- Badge NB OP -->
          <div class="text-black  "
               >
           <span >NB OP</span>
          </div>
          
          <!-- Mode Ã©dition : Input -->
          
          
          <!-- Mode lecture : Affichage avec code couleur -->
          <div *ngIf="!isEditing()" 
               class="text-black text-base"
              >
            {{ getAverageOperators(day) }}
          </div>
        </div>
      </th>
    </ng-container>
  </tr>
</thead>
                <tbody>
  <ng-container *ngFor="let ref of filteredWeekPlanification()!.references">
    <!-- Ligne C -->
    <tr class="border-b border-gray-700/50">
  <td class="sticky left-0 z-10 sticky-cell border-2 border-gray-700 font-semibold whitespace-nowrap px-2 sm:px-4 py-3 sm:py-4 text-sm sm:text-base" rowspan="5">
    {{ ref.reference }}
  </td>
  <td class="text-center font-bold text-blue-700 border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base bg-blue-100">C</td> <!-- Ajout de bg-blue-100 -->
  <td class="text-center font-mono text-white border-2 border-gray-700 py-3 sm:py-4 vertical-text-cell" rowspan="5">
    <div class="vertical-text-wrapper">
      <ng-container *ngIf="getDayEntry(ref, 'lundi')">
        <!-- OF - LECTURE SEULE -->
        <span class="vertical-text-value">{{ getDayEntry(ref, 'lundi')!.of }}</span>
      </ng-container>
    </div>
  </td>
  <ng-container *ngFor="let day of weekDays">
    <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
      <!-- C - LECTURE SEULE -->
    <span class="text-white font-bold text-base sm:text-lg value-display">
  {{ getDayEntry(ref, day)!.c || '-' }}
</span>
      <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
    </td>
  </ng-container>
</tr>
    
    <!-- Ligne M - MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">M</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- M - MODIFIABLE EN MODE Ã‰DITION -->
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.m"
                 (input)="updateDayEntry(ref, day, 'm', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
      class="text-white font-bold text-base sm:text-lg value-display">
  {{ getDayEntry(ref, day)!.m || '-' }}
</span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne DP - MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DP</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- DP - MODIFIABLE EN MODE Ã‰DITION SEULEMENT SI canEditDP() -->
          <input *ngIf="isEditing() && getDayEntry(ref, day) && canEditDP()" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.dp"
                 (input)="updateDayEntry(ref, day, 'dp', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          
          <!-- DP - LECTURE SEULE si pas de permission ou pas en mode Ã©dition -->
          <span *ngIf="(!isEditing() || !canEditDP()) && getDayEntry(ref, day)" 
                [class]="canEditDP() ? 'text-white font-bold text-base sm:text-lg value-display' : 'text-gray-400 font-bold text-base sm:text-lg value-display'">
            {{ getDayEntry(ref, day)!.dp || '-' }}
          </span>
          
          <!-- Message si pas de permission -->
          <div *ngIf="isEditing() && !canEditDP() && getDayEntry(ref, day)" 
               class="text-xs text-orange-400 mt-1"
               title="Seuls les chefs secteurs normaux peuvent modifier DP">
            ðŸ”’
          </div>
          
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne DM - NON MODIFIABLE -->
    <!-- Ligne DM - MODIFIABLE -->
<tr class="border-b border-gray-700/50">
  <td class="text-center font-bold border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base dm-label">DM</td>
  <ng-container *ngFor="let day of weekDays">
    <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
      <!-- DM - MODIFIABLE SI PERMISSION (matricule 2603) -->
      <input *ngIf="isEditing() && getDayEntry(ref, day) && canEditDM()" 
             type="number"
             [value]="getDayEntry(ref, day)!.dm"
             (input)="updateDayEntry(ref, day, 'dm', $any($event.target).value)"
             class="w-full bg-gray-700/50 border border-green-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-base sm:text-lg text-center font-bold dm-input">
      
      <!-- DM - LECTURE SEULE -->
      <span *ngIf="(!isEditing() || !canEditDM()) && getDayEntry(ref, day)" 
            class="text-base sm:text-lg value-display dm-value">
        {{ getDayEntry(ref, day)!.dm || '-' }}
      </span>
      
      <!-- IcÃ´ne verrou si pas de permission -->
      <div *ngIf="isEditing() && !canEditDM() && getDayEntry(ref, day)" 
           class="text-xs text-orange-400 mt-1"
           title="Seul le matricule 2603 peut modifier DM">
        ðŸ”’
      </div>
      
      <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
    </td>
  </ng-container>
</tr>
    
    <!-- Ligne Delta - NON MODIFIABLE -->
    <tr class="border-b-2 border-gray-700">
      <td class="text-center font-bold text-cyan-400 border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">Î”</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <button *ngIf="getDayEntry(ref, day)"
                  (click)="openCausesModal(ref, day)"
                  type="button"
                  [ngClass]="{
                    'delta-excellent': getDayEntry(ref, day)!.delta >= 70,
                    'delta-good': getDayEntry(ref, day)!.delta >= 50 && getDayEntry(ref, day)!.delta < 70,
                    'delta-average': getDayEntry(ref, day)!.delta >= 20 && getDayEntry(ref, day)!.delta < 50,
                    'delta-poor': getDayEntry(ref, day)!.delta < 20
                  }"
                  class="font-bold delta-value text-base sm:text-lg w-full px-2 py-2 rounded-lg hover:scale-105 transition-transform cursor-pointer hover:shadow-lg relative group">
            {{ getDayEntry(ref, day)!.delta || '-' }}
            
            <!-- Indicateur de causes enregistrÃ©es -->
            <span *ngIf="getDayEntry(ref, day)!.causes" 
                  class="absolute top-1 right-1 w-2 h-2 bg-green-400 rounded-full"
                  title="Causes enregistrÃ©es"></span>
          </button>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
  </ng-container>
</tbody>
                </table>
              </div>
            </div>
            
            <!-- Indicateur de dÃ©filement -->
            <div class="scroll-indicator" 
                 *ngIf="showScrollIndicator()"
                 (click)="scrollToStart()">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
              </svg>
              Glisser pour voir les jours
            </div>
          </div>

          <div *ngIf="selectedLigne() && !weekPlanification()" class="h-full flex items-center justify-center">
            <div class="text-center text-gray-400">
              <svg class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <p class="text-base sm:text-lg mb-2">SÃ©lectionnez une semaine</p>
              <p class="text-xs sm:text-sm text-gray-500">pour voir la planification</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulaire de Saisie Rapport Production -->
<!-- Formulaire de Saisie Rapport Production - MODIFIÃ‰ -->
<div *ngIf="showProductionForm()" class="production-form-overlay fixed inset-0 bg-gray-900/90 flex items-center justify-center z-50 p-4">
  <div class="production-form-container bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-y-auto flex flex-col">
    
    <!-- Header - MODIFIÃ‰ -->
    <div class="bg-blue-600 p-4 flex justify-between items-center flex-shrink-0 sticky top-0 z-50">
      <h2 class="text-xl font-bold text-white">SAISIE RAPPORT PRODUCTION - MULTI-OPÃ‰RATEURS</h2>
      <button (click)="closeProductionForm()" class="text-white hover:text-blue-200 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="flex flex-1 min-h-0">
      <!-- Section de sÃ©lection des opÃ©rateurs - MODIFIÃ‰ -->
      <div class="w-1/4 bg-gray-50 p-4 overflow-y-auto border-r border-gray-300">
        <h3 class="text-blue-600 font-semibold text-lg mb-3">SÃ©lection des OpÃ©rateurs</h3>
        
        <!-- Date - MODIFIÃ‰ -->
        <div class="mb-3">
          <label class="block text-blue-600 font-semibold mb-2 text-sm">DATE</label>
          <input 
            type="text" 
            [value]="currentDate()"
            class="w-full bg-gray-100 border border-blue-400 rounded-lg px-3 py-2 text-gray-800 focus:outline-none focus:border-blue-500"
            readonly>
        </div>

        <!-- Ligne sÃ©lectionnÃ©e - MODIFIÃ‰ -->
        <div class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="font-bold text-blue-600 text-xs mb-1">LIGNE SÃ‰LECTIONNÃ‰E</h4>
          <p class="text-gray-800 text-sm font-semibold">{{ selectedLigne()?.ligne }}</p>
        </div>

        <!-- Barre de recherche - MODIFIÃ‰ -->
        <div class="mb-3">
          <div class="search-container p-2 rounded-lg bg-gray-100 border border-gray-300">
            <div class="flex items-center">
              <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input 
                type="text" 
                [value]="searchRecordQuery()"
                (input)="onSearchRecordChange($event)"
                placeholder="Rechercher matricule..." 
                class="search-input flex-1 bg-transparent text-gray-800 text-sm focus:outline-none">
            </div>
          </div>
        </div>

        <!-- Boutons de sÃ©lection globale - MODIFIÃ‰ -->
        <div class="flex space-x-2 mb-3">
          <button 
            (click)="selectAllOperators()"
            class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-semibold transition-colors">
            Tout
          </button>
          <button 
            (click)="deselectAllOperators()"
            class="flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold transition-colors">
            Aucun
          </button>
        </div>

        <!-- Liste des opÃ©rateurs - MODIFIÃ‰ -->
        <div class="space-y-1 max-h-64 overflow-y-auto operator-list">
          <div *ngFor="let operator of filteredOperatorsForSelection()" 
               class="p-2 rounded transition-colors cursor-pointer hover:bg-blue-100"
               [class.bg-blue-100]="selectedMatricules().includes(operator.matricule)"
               (click)="toggleMatriculeSelection(operator.matricule)">
            <div class="flex items-center">
              <div class="mr-2">
                <input 
                  type="checkbox" 
                  [checked]="selectedMatricules().includes(operator.matricule)"
                  (change)="toggleMatriculeSelection(operator.matricule)"
                  class="w-3 h-3 text-blue-600 bg-white border-gray-400 rounded focus:ring-blue-500">
              </div>
              <div class="flex-1">
                <div class="font-semibold text-gray-800 text-xs">{{ operator.matricule }}</div>
                <div class="text-xs text-gray-600">{{ operator.nom }} {{ operator.prenom }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- RÃ©sumÃ© de sÃ©lection - MODIFIÃ‰ -->
        <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
          <div class="text-center">
            <span class="text-blue-600 font-semibold text-xs">OpÃ©rateurs sÃ©lectionnÃ©s:</span>
            <div class="text-gray-800 font-bold text-base mt-1">{{ selectedMatricules().length }}</div>
          </div>
        </div>

        <!-- Bouton voir enregistrements - MODIFIÃ‰ -->
        <button 
          (click)="toggleRecordsPanel()"
          class="w-full mt-3 px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded text-xs font-semibold transition-colors flex items-center justify-center">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Voir Enregistrements
        </button>
      </div>

      <!-- Contenu principal - MODIFIÃ‰ -->
      <div class="flex-1 p-4 overflow-y-auto bg-white">
        <div *ngIf="selectedMatricules().length === 0" class="h-full flex items-center justify-center">
          <div class="text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
            </svg>
            <p class="text-base font-medium">SÃ©lectionnez des opÃ©rateurs pour commencer la saisie</p>
            <p class="text-sm text-gray-400 mt-1">Utilisez les cases Ã  cocher Ã  gauche</p>
          </div>
        </div>

        <!-- Tableau de saisie - MODIFIÃ‰ -->
        <div *ngIf="selectedMatricules().length > 0" class="space-y-3">
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="w-full text-sm">
               <thead class="bg-white sticky top-0 z-10 border-b border-gray-300">
                <tr>
                  <th class="px-3 py-2 text-left text-blue-600 font-semibold ">OpÃ©rateur</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold">Phase 1</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold ">Phase 2</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold ">Phase 3</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold ">Heures</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let matricule of selectedMatricules()" 
                    class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                  
                  <!-- OpÃ©rateur -->
                  <td class="px-3 py-2">
                    <div class="font-semibold text-gray-800 text-sm">{{ getSafeOperatorFormData(matricule).nomPrenom }}</div>
                    <div class="text-xs text-gray-500">{{ matricule }}</div>
                  </td>
                  
                  <!-- Phase 1 -->
                  <td class="px-2 py-2">
                    <div class="space-y-1">
                      <select 
                        [value]="getOperatorPhaseValue(matricule, 0)"
                        (change)="updateOperatorPhase(matricule, 0, $any($event.target).value)"
                        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
                        <option value="">Phase 1</option>
                        <option *ngFor="let phase of availablePhases()" [value]="phase">
                          {{ phase }}
                        </option>
                      </select>
                      <div class="flex items-center space-x-1">
                        <span class="text-xs text-gray-600 whitespace-nowrap">Heures:</span>
                        <input 
                          type="number" 
                          [value]="getOperatorPhaseHeures(matricule, 0)"
                          (input)="updateOperatorPhaseHeures(matricule, 0, $any($event.target).value)"
                          min="0"
                          max="8"
                          step="0.5"
                          placeholder="0"
                          class="w-14 bg-white border border-blue-300 rounded px-1 py-0.5 text-gray-800 text-xs text-center focus:outline-none focus:border-blue-500">
                      </div>
                    </div>
                  </td>
                  
                  <!-- Phase 2 -->
                  <td class="px-2 py-2">
                    <div class="space-y-1">
                      <select 
                        [value]="getOperatorPhaseValue(matricule, 1)"
                        (change)="updateOperatorPhase(matricule, 1, $any($event.target).value)"
                        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
                        <option value="">Phase 2</option>
                        <option *ngFor="let phase of availablePhases()" [value]="phase">
                          {{ phase }}
                        </option>
                      </select>
                      <div class="flex items-center space-x-1">
                        <span class="text-xs text-gray-600 whitespace-nowrap">Heures:</span>
                        <input 
                          type="number" 
                          [value]="getOperatorPhaseHeures(matricule, 1)"
                          (input)="updateOperatorPhaseHeures(matricule, 1, $any($event.target).value)"
                          min="0"
                          max="8"
                          step="0.5"
                          placeholder="0"
                          class="w-14 bg-white border border-blue-300 rounded px-1 py-0.5 text-gray-800 text-xs text-center focus:outline-none focus:border-blue-500">
                      </div>
                    </div>
                  </td>
                  
                  <!-- Phase 3 -->
                  <td class="px-2 py-2">
                    <div class="space-y-1">
                      <select 
                        [value]="getOperatorPhaseValue(matricule, 2)"
                        (change)="updateOperatorPhase(matricule, 2, $any($event.target).value)"
                        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
                        <option value="">Phase 3</option>
                        <option *ngFor="let phase of availablePhases()" [value]="phase">
                          {{ phase }}
                        </option>
                      </select>
                      <div class="flex items-center space-x-1">
                        <span class="text-xs text-gray-600 whitespace-nowrap">Heures:</span>
                        <input 
                          type="number" 
                          [value]="getOperatorPhaseHeures(matricule, 2)"
                          (input)="updateOperatorPhaseHeures(matricule, 2, $any($event.target).value)"
                          min="0"
                          max="8"
                          step="0.5"
                          placeholder="0"
                          class="w-14 bg-white border border-blue-300 rounded px-1 py-0.5 text-gray-800 text-xs text-center focus:outline-none focus:border-blue-500">
                      </div>
                    </div>
                  </td>
                  
                  <!-- Total Heures -->
                  <td class="px-2 py-2">
                    <div class="text-center">
                      <div class="text-green-600 font-bold text-base">
                        {{ getSafeOperatorFormData(matricule).totalHeures }}h
                      </div>
                      <div class="text-xs text-gray-500 mt-0.5">
                        {{ 8 - getSafeOperatorFormData(matricule).totalHeures }}h restantes
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Boutons d'action - MODIFIÃ‰ -->
          <div class="flex justify-between pt-3 border-t border-gray-300">
            <button 
              (click)="closeProductionForm()"
              class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded font-semibold text-sm transition-colors">
              Annuler
            </button>
            <button 
              (click)="saveAllProductionRecords()"
              class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded font-semibold text-sm transition-colors">
              Sauvegarder ({{ selectedMatricules().length }})
            </button>
          </div>
        </div>
      </div>

      <!-- Panneau des enregistrements - MODIFIÃ‰ -->
     <!-- Panneau des enregistrements - MODIFIÃ‰ -->
<div *ngIf="showRecordsPanel()" class="w-1/3 bg-gray-50 border-l border-gray-300 flex flex-col">
  <div class="p-4 border-b border-gray-300 flex-shrink-0">
    <div class="flex justify-between items-center">
      <h3 class="text-blue-600 font-semibold text-base">Enregistrements du {{ currentDate() }}</h3>
      <button 
        (click)="toggleRecordsPanel()"
        class="text-gray-500 hover:text-gray-700 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Zone scrollable des enregistrements -->
  <div class="flex-1 p-4 overflow-y-auto custom-scrollbar records-panel-scroll">
    <div class="space-y-2">
      <div *ngFor="let record of filteredProductionRecords()" 
           (click)="showRecordDetails(record)"
           class="bg-white p-2 rounded border border-gray-300 hover:border-blue-400 transition-colors cursor-pointer">
        <div class="flex justify-between items-start mb-1">
          <div>
            <span class="text-blue-600 font-semibold text-xs">{{ record.matricule }}</span>
            <span class="text-gray-800 ml-1 text-xs">- {{ record.nomPrenom }}</span>
          </div>
          <span class="text-green-600 font-semibold text-xs">{{ record.totalHeures }}h</span>
        </div>
        
        <div class="text-xs text-gray-600">
          <div>Ligne: {{ record.ligne1 }}</div>
          <div class="mt-0.5">
            <span class="text-blue-500">Phases:</span>
            <span class="ml-1">{{ formatPhases(record.phasesLigne1) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="filteredProductionRecords().length === 0" class="text-center text-gray-400 py-6">
      <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <p class="text-sm">Aucun enregistrement pour cette date</p>
    </div>
  </div>
</div>
    </div> <!-- FIN du div flex flex-1 min-h-0 -->
  </div> <!-- FIN du div production-form-container -->
</div> <!-- FIN du div production-form-overlay -->


<!-- Modal de dÃ©tails des enregistrements (inchangÃ©) -->
<!-- Modal de dÃ©tails avec Ã©dition - MODIFIÃ‰ -->
<div *ngIf="showRecordsDetails() && selectedRecordForDetails() && selectedRecordForEdit()" 
     class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
  
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    
    <!-- Header -->
    <div class="bg-blue-600 p-4 flex justify-between items-center sticky top-0 z-10">
      <div>
        <h2 class="text-xl font-bold text-white">
          {{ editMode() === 'view' ? 'DÃ‰TAILS DU RAPPORT' : 'MODIFICATION DU RAPPORT' }}
        </h2>
        <p class="text-blue-200 text-sm mt-1">
          {{ selectedRecordForEdit()!.nomPrenom }} ({{ selectedRecordForEdit()!.matricule }})
        </p>
      </div>
      <button (click)="closeRecordDetails()" 
              class="text-white hover:text-blue-200 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Informations gÃ©nÃ©rales -->
    <div class="p-6">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="text-gray-600 text-sm font-semibold">SEMAINE</div>
          <div class="text-gray-800 font-bold text-lg">{{ selectedRecordForEdit()!.semaine }}</div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="text-gray-600 text-sm font-semibold">JOUR</div>
          <div class="text-gray-800 font-bold text-lg capitalize">{{ selectedRecordForEdit()!.jour }}</div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="text-gray-600 text-sm font-semibold">LIGNE</div>
          <div class="text-gray-800 font-bold text-lg">{{ selectedRecordForEdit()!.ligne }}</div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="text-gray-600 text-sm font-semibold">TOTAL HEURES</div>
          <div class="text-green-600 font-bold text-2xl">{{ selectedRecordForEdit()!.totalHeures }}h</div>
        </div>
      </div>

      <!-- Phases du rapport -->
      <div class="mb-6">
        <h3 class="text-gray-700 font-bold text-lg mb-3">PHASES DE TRAVAIL</h3>
        
        <div class="space-y-3">
          <div *ngFor="let phase of selectedRecordForEdit()!.phases; let i = index" 
               class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
            
            <!-- Mode Ã©dition -->
            <div *ngIf="editMode() === 'edit'" class="flex-1 flex space-x-3">
              <!-- Phase -->
              <div class="flex-1">
                <label class="block text-gray-600 text-sm mb-1">Phase {{ i + 1 }}</label>
                <select 
                  [value]="phase.phase"
                  (change)="updateEditPhase(i, 'phase', $any($event.target).value)"
                  class="w-full bg-white border border-blue-300 rounded px-3 py-2 text-gray-800 focus:outline-none focus:border-blue-500">
                  <option value="">SÃ©lectionner une phase</option>
                  <option *ngFor="let phaseOption of availablePhases()" [value]="phaseOption">
                    {{ phaseOption }}
                  </option>
                </select>
              </div>
              
              <!-- Heures -->
              <div class="w-32">
                <label class="block text-gray-600 text-sm mb-1">Heures</label>
                <input 
                  type="number" 
                  [value]="phase.heures"
                  (input)="updateEditPhase(i, 'heures', $any($event.target).value)"
                  min="0"
                  max="8"
                  step="0.5"
                  class="w-full bg-white border border-blue-300 rounded px-3 py-2 text-gray-800 text-center focus:outline-none focus:border-blue-500">
              </div>
              
              <!-- Bouton supprimer -->
              <div class="flex items-end">
                <button 
                  (click)="removeEditPhase(i)"
                  type="button"
                  class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded transition-colors"
                  *ngIf="selectedRecordForEdit()!.phases.length > 1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Mode vue -->
            <div *ngIf="editMode() === 'view'" class="flex-1 flex justify-between items-center">
              <div>
                <div class="text-blue-600 font-semibold text-lg">{{ phase.phase }}</div>
                <div class="text-gray-500 text-sm">Phase {{ i + 1 }}</div>
              </div>
              <div class="text-green-600 font-bold text-xl">{{ phase.heures }}h</div>
            </div>
          </div>
          
          <!-- Bouton ajouter phase (mode Ã©dition) -->
          <div *ngIf="editMode() === 'edit' && selectedRecordForEdit()!.phases.length < 3" 
               class="text-center pt-2">
            <button 
              (click)="addEditPhase()"
              type="button"
              class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center justify-center mx-auto">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Ajouter une phase
            </button>
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex justify-between pt-6 border-t border-gray-200">
        <!-- Mode vue -->
        <div *ngIf="editMode() === 'view'" class="flex space-x-3">
          <button 
            (click)="enableEditMode()"
            class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-colors flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Modifier
          </button>
          
          <button 
            (click)="deleteRecord()"
            class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Supprimer
          </button>
        </div>
        
        <!-- Mode Ã©dition -->
        <div *ngIf="editMode() === 'edit'" class="flex space-x-3">
          <button 
            (click)="cancelEdit()"
            class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg font-semibold transition-colors">
            Annuler
          </button>
          
          <button 
            (click)="saveRecordEdit()"
            class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-colors flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Enregistrer
          </button>
        </div>
        
        <button 
          (click)="closeRecordDetails()"
          class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-semibold transition-colors">
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>


<!-- MODAL DES CAUSES 5M - VERSION MULTI-RÃ‰FÃ‰RENCES -->

<div *ngIf="showCausesModal()" 
     (click)="$event.target === $event.currentTarget ? closeCausesModal() : null"
     class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
     [ngClass]="{ 'cursor-not-allowed': !canFermerModal(), 'cursor-pointer': canFermerModal() }">
  
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl border-2 border-gray-300">
    
    <!-- Header -->
    <div class="bg-gray-800 p-3 flex justify-between items-center rounded-t-xl">
      <div>
        <h2 class="text-xl font-bold text-white">ANALYSE DES CAUSES - 5M</h2>
        <p class="text-gray-300 text-sm mt-1" *ngIf="selectedEntryForCauses()">
          {{ selectedEntryForCauses()!.reference.reference }} - 
          {{ selectedEntryForCauses()!.day | titlecase }}
        </p>
      </div>
      <button (click)="closeCausesModal()" 
              type="button"
              [disabled]="!canFermerModal()"
              [ngClass]="{
                'text-white hover:text-gray-300': canFermerModal(),
                'text-gray-600 cursor-not-allowed': !canFermerModal()
              }"
              [title]="canFermerModal() ? 'Fermer' : 'Justifiez l\'Ã©cart avant de fermer'"
              class="transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Contenu principal -->
    <div class="p-3 space-y-2 max-h-[50vh] overflow-y-auto">
      
      <!-- Ã‰cart Ã  justifier -->
      <div class="bg-gray-100 rounded-lg p-3 border border-gray-300">
        <div class="text-center">
          <div class="text-gray-700 font-bold text-base mb-1">Ã‰cart Ã  justifier</div>
          <div class="text-3xl font-bold text-gray-900 mb-2">{{ getEcartCDP() }}</div>
          
          <div class="flex justify-between items-center">
            <div>
              <div class="text-gray-600 text-sm font-semibold">Total des causes</div>
              <div class="text-xl font-bold text-gray-900">
                {{ getTotalCauses() }}
              </div>
            </div>
            
            <div class="text-right">
              <div class="text-gray-600 text-sm font-semibold">DiffÃ©rence</div>
              <div class="text-xl font-bold">{{ getDifferenceRestante() }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Champs des causes en grille 3x2 -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
        
        <!-- M1: MatiÃ¨re premiÃ¨re -->
        <div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
          <h4 class="text-gray-700 font-bold text-sm mb-2">M1: MatiÃ¨re premiÃ¨re</h4>
          
          <!-- QuantitÃ© totale -->
          <div class="mb-2">
            <label class="block text-gray-600 text-xs mb-1">QuantitÃ© totale</label>
            <input 
              type="number" 
              [value]="currentMPQuantite()"
              (input)="updateMPQuantite($any($event.target).value)"
              min="0"
              placeholder="Ex: 500"
              class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
          </div>

          <!-- Liste des rÃ©fÃ©rences MP -->
          <div *ngIf="currentMPQuantite() > 0" class="space-y-1">
            <label class="block text-gray-600 text-xs">RÃ©fÃ©rences (2-3 max)</label>
            
            <!-- RÃ©fÃ©rences sÃ©lectionnÃ©es -->
            <div *ngFor="let ref of selectedMPReferences(); let i = index" 
                 class="flex items-center space-x-1 bg-blue-50 rounded px-2 py-1 border border-blue-200">
              <span class="text-xs font-semibold text-gray-800 flex-1">{{ ref }}</span>
              <button (click)="removeMPReference(i)"
                      type="button"
                      class="text-red-500 hover:text-red-700 p-0.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <!-- Ajouter une rÃ©fÃ©rence -->
            <div *ngIf="selectedMPReferences().length < 3" class="relative">
              <input 
                type="text"
                [value]="currentMPSearchQuery()"
                (input)="onSearchMPChange($event)"
                (focus)="showMPSuggestions.set(true)"
                placeholder="Tapez pour ajouter..."
                class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500"
                autocomplete="off">
              
              <!-- Suggestions -->
              <div *ngIf="showMPSuggestions() && filteredMPRefs().length > 0" 
                   class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded shadow-md max-h-24 overflow-y-auto">
                <div *ngFor="let ref of filteredMPRefs()" 
                     (mousedown)="addMPReference(ref)"
                     class="px-2 py-1 text-gray-700 hover:bg-blue-100 cursor-pointer transition-colors border-b border-gray-100 last:border-b-0 text-xs">
                  {{ ref }}
                </div>
              </div>
            </div>

            <!-- Message limite -->
            <div *ngIf="selectedMPReferences().length >= 3" 
                 class="text-xs text-orange-600 text-center">
              Maximum 3 rÃ©fÃ©rences atteint
            </div>
          </div>
        </div>
        
        <!-- M2: Absence -->
        <div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
          <h4 class="text-gray-700 font-bold text-sm mb-2">M2: Absence</h4>
          <input type="number" 
                 [value]="currentCauses().m2Absence || ''"
                 (input)="updateCause('m2Absence', $any($event.target).value)"
                 min="0"
                 placeholder="Saisir quantitÃ©"
                 class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
        </div>
        
        <!-- M2: Rendement -->
        <div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
          <h4 class="text-gray-700 font-bold text-sm mb-2">M2: Rendement</h4>
          <input type="number" 
                 [value]="currentCauses().m2Rendement || ''"
                 (input)="updateCause('m2Rendement', $any($event.target).value)"
                 min="0"
                 placeholder="Saisir quantitÃ©"
                 class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
        </div>

        <!-- M3: MÃ©thode -->
        <div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
          <h4 class="text-gray-700 font-bold text-sm mb-2">M3: MÃ©thode</h4>
          <input type="number" 
                 [value]="currentCauses().m3Methode || ''"
                 (input)="updateCause('m3Methode', $any($event.target).value)"
                 min="0"
                 placeholder="Saisir quantitÃ©"
                 class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
        </div>
        
        <!-- M4: Maintenance -->
        <div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
          <h4 class="text-gray-700 font-bold text-sm mb-2">M4: Maintenance</h4>
          <input type="number" 
                 [value]="currentCauses().m4Maintenance || ''"
                 (input)="updateCause('m4Maintenance', $any($event.target).value)"
                 min="0"
                 placeholder="Saisir quantitÃ©"
                 class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
        </div>

        <!-- M6: Environnement -->
<div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
  <h4 class="text-gray-700 font-bold text-sm mb-2">M6: Environnement</h4>
  <input type="number" 
         [value]="currentCauses().m6Environnement || ''"
         (input)="updateCause('m6Environnement', $any($event.target).value)"
         min="0"
         placeholder="Saisir quantitÃ©"
         class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
</div>
        
        <!-- M5: QualitÃ© -->
        <div class="bg-gray-50 rounded-lg p-2 border border-gray-300">
          <h4 class="text-gray-700 font-bold text-sm mb-2">M5: QualitÃ©</h4>
          
          <!-- QuantitÃ© totale qualitÃ© -->
          <div class="mb-2">
            <label class="block text-gray-600 text-xs mb-1">QuantitÃ© totale</label>
            <input 
              type="number" 
              [value]="currentQualiteQuantite() || ''"
              (input)="updateQualiteQuantite($any($event.target).value)"
              min="0"
              placeholder="Ex: 300"
              class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
          </div>

          <!-- Liste des rÃ©fÃ©rences QualitÃ© -->
          <div *ngIf="currentQualiteQuantite() > 0" class="space-y-1">
            <label class="block text-gray-600 text-xs">RÃ©fÃ©rences (2-3 max)</label>
            
            <!-- RÃ©fÃ©rences qualitÃ© sÃ©lectionnÃ©es -->
            <div *ngFor="let ref of selectedQualiteReferences(); let i = index" 
                 class="flex items-center space-x-1 bg-green-50 rounded px-2 py-1 border border-green-200">
              <span class="text-xs font-semibold text-gray-800 flex-1">{{ ref }}</span>
              <button (click)="removeQualiteReference(i)"
                      type="button"
                      class="text-red-500 hover:text-red-700 p-0.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>

            <!-- Ajouter une rÃ©fÃ©rence qualitÃ© -->
            <div *ngIf="selectedQualiteReferences().length < 3" class="relative">
              <input 
                type="text"
                [value]="currentQualiteSearchQuery()"
                (input)="onSearchQualiteChange($event)"
                (focus)="showQualiteSuggestions.set(true)"
                placeholder="Tapez pour ajouter..."
                class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500"
                autocomplete="off">
              
              <!-- Suggestions QUALITÃ‰ -->
              <div *ngIf="showQualiteSuggestions() && filteredQualiteRefs().length > 0" 
                   class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded shadow-md max-h-24 overflow-y-auto">
                <div *ngFor="let ref of filteredQualiteRefs()" 
                     (mousedown)="addQualiteReference(ref)"
                     class="px-2 py-1 text-gray-700 hover:bg-green-100 cursor-pointer transition-colors border-b border-gray-100 last:border-b-0 text-xs">
                  {{ ref }}
                </div>
              </div>
            </div>

            <!-- Message limite -->
            <div *ngIf="selectedQualiteReferences().length >= 3" 
                 class="text-xs text-orange-600 text-center">
              Maximum 3 rÃ©fÃ©rences atteint
            </div>
            <div class="mt-2 pt-2 border-t border-gray-200">
      <label class="block text-gray-600 text-xs mb-1">
        Commentaire <span class="text-red-500">*</span>
      </label>
      
      <!-- Loader pendant le chargement -->
      <div *ngIf="isLoadingCommentaires()" class="text-center py-1">
        <div class="inline-flex items-center">
          <div class="animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-blue-500"></div>
          <span class="ml-2 text-xs text-gray-500">Chargement...</span>
        </div>
      </div>
      
      <!-- SÃ©lecteur de commentaires -->
      <select 
        *ngIf="!isLoadingCommentaires() && availableCommentaires().length > 0"
        [value]="selectedCommentaireId() || ''"
        (change)="selectedCommentaireId.set($any($event.target).value ? +$any($event.target).value : null)"
        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
        
        <option value="">-- SÃ©lectionner un commentaire --</option>
        <option *ngFor="let commentaire of availableCommentaires()" 
                [value]="commentaire.id"
                [selected]="commentaire.id === selectedCommentaireId()">
          {{ commentaire.commentaire }}
        </option>
      </select>
      
      <!-- Message si aucun commentaire disponible -->
      <div *ngIf="!isLoadingCommentaires() && availableCommentaires().length === 0" 
           class="text-xs text-orange-500 text-center py-1">
        Aucun commentaire disponible
      </div>
      
      <!-- Message d'aide/validation -->
      <div *ngIf="currentQualiteQuantite() > 0 && !selectedCommentaireId()" 
           class="text-xs text-red-500 mt-1 flex items-center">
        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        SÃ©lection obligatoire pour la qualitÃ©
      </div>
      
      <!-- Affichage du commentaire sÃ©lectionnÃ© -->
      <div *ngIf="selectedCommentaireId()" class="mt-1">
        <div class="flex items-center text-xs text-green-600">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          {{ getSelectedCommentaireText() }}
        </div>
      </div>
    </div>
          </div>
        </div>
        
      </div>
      
    </div>

    <!-- Boutons d'action -->
    <div class="bg-gray-50 p-3 border-t border-gray-200 rounded-b-xl">

      <!-- ðŸ”´ BanniÃ¨re d'avertissement si le modal est forcÃ© et Ã©cart pas encore justifiÃ© -->
      <div *ngIf="causesModalForcee() && getTotalCauses() !== getEcartCDP()" 
           class="bg-red-50 border border-red-300 rounded-lg px-3 py-2 mb-3 flex items-start gap-2">
        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376a12 12 0 1 0 20.817 0M12 15.75h.008v.008H12v-.008z"/>
        </svg>
        <div>
          <p class="text-red-700 font-semibold text-sm">Vous devez justifier cet Ã©cart</p>
          <p class="text-red-600 text-xs mt-0.5">
            Le Total des causes doit Ãªtre Ã©gal Ã  l'Ã‰cart Ã  justifier ({{ getEcartCDP() }}) avant de pouvoir fermer ce modal.
            <span *ngIf="ecartsEnAttente().length > 1">({{ ecartsEnAttente().length }} Ã©cart(s) Ã  justifier au total)</span>
          </p>
        </div>
      </div>

      <div class="flex justify-between items-center">
        <div class="text-gray-700 text-sm font-semibold">
          Statut: 
          <span [class.text-green-600]="getTotalCauses() === getEcartCDP()"
                [class.text-red-600]="getTotalCauses() !== getEcartCDP()">
            {{ getTotalCauses() === getEcartCDP() ? 'Ã‰cart justifiÃ© âœ“' : 'Ã‰cart non justifiÃ© âœ—' }}
          </span>
        </div>
        
        <div class="flex space-x-2">
          <!-- Annuler : bloquÃ© si modal forcÃ© et pas justifiÃ© -->
          <button (click)="closeCausesModal()"
                  type="button"
                  [disabled]="!canFermerModal()"
                  [ngClass]="{
                    'bg-gray-400 hover:bg-gray-500 cursor-pointer': canFermerModal(),
                    'bg-gray-300 cursor-not-allowed opacity-60': !canFermerModal()
                  }"
                  [title]="canFermerModal() ? 'Annuler' : 'Justifiez l\'Ã©cart avant de fermer'"
                  class="px-4 py-2 text-white rounded-lg text-sm font-semibold transition-colors">
            Annuler
          </button>
          <button (click)="saveCauses()"
                  type="button"
                  class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-semibold transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Sauvegarder
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

  <!-- Message de succÃ¨s -->
  <div *ngIf="showSuccess()" class="success-notification">
    <div class="success-content">
      <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <span class="text-sm sm:text-base">{{ successMessage() }}</span>
    </div>
  </div>

  <!-- Loader global -->
  <div *ngIf="loading()" class="loader-overlay">
    <div class="loader-container">
      <div class="industrial-loader"></div>
      <p class="text-cyan-400 mt-4 font-semibold text-sm sm:text-base">Chargement...</p>
    </div>
  </div>