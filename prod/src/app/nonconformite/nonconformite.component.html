<!-- components/nonconformite/nonconformite.component.html -->
<div class="nonconformite-container">
  <div class="header">
    <h2>ğŸ”´ Ajouter une Non-ConformitÃ©</h2>
  </div>

  <!-- Messages d'erreur et de succÃ¨s -->
  <div class="alerts">
    <div *ngIf="errorMessage" class="alert alert-error">
      âš ï¸ {{ errorMessage }}
    </div>
    
    <div *ngIf="successMessage" class="alert alert-success">
      âœ… {{ successMessage }}
    </div>
  </div>

  <form [formGroup]="nonconfForm" (ngSubmit)="onSubmit()" class="nonconf-form">
  
    <!-- Ligne 1: Date | Ligne | RÃ©fÃ©rence -->
    <div class="form-row">
      <!-- Date -->
      <div class="form-group">
        <label for="date">Date <span class="required">*</span></label>
        <input
          type="date"
          id="date"
          formControlName="date"
          class="form-control"
          [class.error]="hasError('date')"
        />
        <small *ngIf="hasError('date')" class="error-message">
          {{ getErrorMessage('date') }}
        </small>
        <small class="help-text">SÃ©lectionnez la date de la non-conformitÃ©</small>
      </div>

      <!-- Ligne (SÃ©lection) -->
      <div class="form-group">
        <label for="ligne">Ligne <span class="required">*</span></label>
        <select
          id="ligne"
          formControlName="ligne"
          class="form-control"
          [class.error]="hasError('ligne')"
        >
          <option value="">SÃ©lectionnez une ligne</option>
          <option *ngFor="let ligne of availableLines" [value]="ligne">
            {{ ligne }}
          </option>
        </select>
        <small *ngIf="hasError('ligne')" class="error-message">
          {{ getErrorMessage('ligne') }}
        </small>
        <small class="help-text">Choisissez d'abord une ligne</small>
      </div>

      <!-- RÃ©fÃ©rence (dÃ©pend de la ligne) -->
      <div class="form-group">
        <label for="reference">RÃ©fÃ©rence <span class="required">*</span></label>
        <select
          id="reference"
          formControlName="reference"
          class="form-control"
          [class.error]="hasError('reference')"
          [disabled]="!nonconfForm.get('ligne')?.value"
        >
          <option value="">
            {{ nonconfForm.get('ligne')?.value ? 'SÃ©lectionnez une rÃ©fÃ©rence' : 'Choisissez d\'abord une ligne' }}
          </option>
          <option *ngFor="let ref of availableReferences" [value]="ref.reference">
            {{ ref.reference }} ({{ ref.type }})
          </option>
        </select>
        <small *ngIf="hasError('reference')" class="error-message">
          {{ getErrorMessage('reference') }}
        </small>
        <small class="help-text">
          {{ availableReferences.length }} rÃ©fÃ©rence(s) disponible(s)
        </small>
      </div>
    </div>

    <!-- Ligne 2: Source Type | Type Interne (conditionnel) | Type -->
    <div class="form-row">
      <!-- Source Type -->
      <div class="form-group">
        <label for="sourceType">Source <span class="required">*</span></label>
        <select
          id="sourceType"
          formControlName="sourceType"
          class="form-control"
          [class.error]="hasError('sourceType')"
        >
          <option value="fournisseur">Fournisseur</option>
          <option value="interne">Interne</option>
        </select>
        <small *ngIf="hasError('sourceType')" class="error-message">
          {{ getErrorMessage('sourceType') }}
        </small>
      </div>

      <!-- Type Interne (conditionnel) -->
      <div class="form-group" *ngIf="nonconfForm.get('sourceType')?.value === 'interne'">
        <label for="typeInterne">Type Interne <span class="required">*</span></label>
        <select
          id="typeInterne"
          formControlName="typeInterne"
          class="form-control"
          [class.error]="hasError('typeInterne')"
        >
          <option value="">SÃ©lectionner un type</option>
          <option value="Essai d'arrachement">Essai d'arrachement</option>
          <option value="Essai de maintenance">Essai de maintenance</option>
          <option value="Machine">Machine</option>
          <option value="Main-d'Å“uvre">Main-d'Å“uvre</option>
          <option value="MatiÃ¨re">MatiÃ¨re</option>
        </select>
        <small *ngIf="hasError('typeInterne')" class="error-message">
          {{ getErrorMessage('typeInterne') }}
        </small>
      </div>

      <!-- Espaceur -->
      <div class="form-group" *ngIf="nonconfForm.get('sourceType')?.value !== 'interne'">
        <label>&nbsp;</label>
        <div class="form-control placeholder" style="visibility: hidden;">
          Placeholder
        </div>
      </div>

      <!-- Type (MP/SE) - Auto-rempli -->
      <div class="form-group">
        <label for="type">Type</label>
        <select
          id="type"
          formControlName="type"
          class="form-control"
          [class.error]="hasError('type')"
          [disabled]="true"
        >
          <option value="MP">MP (MatiÃ¨re PremiÃ¨re)</option>
          <option value="SE">SE (Sous-Ensemble)</option>
        </select>
        <small class="help-text">DÃ©terminÃ© automatiquement</small>
      </div>
    </div>

    <!-- Ligne 3: QuantitÃ© de Rebut | Sortie Ligne | DÃ©fauts -->
    <div class="form-row">
      <!-- QuantitÃ© Rebut -->
      <div class="form-group">
        <label for="qteRebut">QuantitÃ© de Rebut <span class="required">*</span></label>
        <input
          type="number"
          id="qteRebut"
          formControlName="qteRebut"
          placeholder="0"
          class="form-control"
          [class.error]="hasError('qteRebut')"
          min="0"
        />
        <small *ngIf="hasError('qteRebut')" class="error-message">
          {{ getErrorMessage('qteRebut') }}
        </small>
      </div>

      <!-- Sortie Ligne -->
      <div class="form-group">
        <label for="sortieLigne">Sortie Ligne <span class="required">*</span></label>
        <input
          type="number"
          id="sortieLigne"
          formControlName="sortieLigne"
          placeholder="0"
          class="form-control"
          [class.error]="hasError('sortieLigne')"
          min="0"
        />
        <small *ngIf="hasError('sortieLigne')" class="error-message">
          {{ getErrorMessage('sortieLigne') }}
        </small>
      </div>

      <!-- DÃ©fauts -->
      <div class="form-group">
        <label for="defauts">DÃ©fauts <span class="required">*</span></label>
        <select
          id="defauts"
          formControlName="defauts"
          class="form-control"
          [class.error]="hasError('defauts')"
        >
          <option value="">SÃ©lectionner un dÃ©faut</option>
          <option *ngFor="let defaut of defautsList" [value]="defaut">
            {{ defaut }}
          </option>
        </select>
        <small *ngIf="hasError('defauts')" class="error-message">
          {{ getErrorMessage('defauts') }}
        </small>
      </div>
    </div>

    <!-- Note d'avertissement -->
    <div *ngIf="nonconfForm.invalid && nonconfForm.touched" class="warning-note">
      âš ï¸ Tous les champs marquÃ©s d'un * sont obligatoires
    </div>

    <!-- Boutons d'action -->
    <div class="form-actions">
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="isSubmitting || nonconfForm.invalid"
      >
        <span *ngIf="!isSubmitting">âœ“ Ajouter</span>
        <span *ngIf="isSubmitting">â³ Ajout en cours...</span>
      </button>

      <button
        type="button"
        class="btn btn-secondary"
        (click)="resetForm()"
        [disabled]="isSubmitting"
      >
        ğŸ”„ RÃ©initialiser
      </button>
    </div>
  </form>

  <!-- ============ FILTRES DE RECHERCHE ============ -->
  <div class="filters-section" *ngIf="saisies.length > 0">
    <h3>ğŸ” Filtres de recherche</h3>
    
    <form [formGroup]="filterForm" (ngSubmit)="applyFilters()">
      <!-- Ligne 1: Date | Ligne | Type -->
      <div class="filters-row">
        <!-- Filtre Date -->
        <div class="filter-group">
          <label for="filterDate">Date</label>
          <input
            type="date"
            id="filterDate"
            formControlName="date"
            class="form-control"
          />
        </div>

        <!-- Filtre Ligne -->
        <div class="filter-group">
          <label for="filterLigne">Ligne</label>
          <select
            id="filterLigne"
            formControlName="ligne"
            class="form-control"
          >
            <option value="">Toutes les lignes</option>
            <option *ngFor="let ligne of availableLines" [value]="ligne">
              {{ ligne }}
            </option>
          </select>
        </div>

        <!-- Filtre Type -->
        <div class="filter-group">
          <label for="filterType">Type</label>
          <select
            id="filterType"
            formControlName="type"
            class="form-control"
          >
            <option value="">Tous les types</option>
            <option value="MP">MP</option>
            <option value="SE">SE</option>
          </select>
        </div>
      </div>

      <!-- Ligne 2: RÃ©fÃ©rence | DÃ©faut | Source -->
      <div class="filters-row">
        <!-- Filtre RÃ©fÃ©rence -->
        <div class="filter-group">
          <label for="filterReference">RÃ©fÃ©rence</label>
          <input
            type="text"
            id="filterReference"
            formControlName="reference"
            placeholder="Rechercher rÃ©fÃ©rence..."
            class="form-control"
          />
        </div>

        <!-- Filtre DÃ©faut -->
        <div class="filter-group">
          <label for="filterDefaut">DÃ©faut</label>
          <select
            id="filterDefaut"
            formControlName="defaut"
            class="form-control"
          >
            <option value="">Tous les dÃ©fauts</option>
            <option *ngFor="let defaut of defautsList" [value]="defaut">
              {{ defaut }}
            </option>
          </select>
        </div>

        <!-- Filtre Source Type -->
        <div class="filter-group">
          <label for="filterSourceType">Source</label>
          <select
            id="filterSourceType"
            formControlName="sourceType"
            class="form-control"
          >
            <option value="">Toutes les sources</option>
            <option value="fournisseur">Fournisseur</option>
            <option value="interne">Interne</option>
          </select>
        </div>
      </div>

      <!-- Boutons de filtrage -->
      <div class="filter-actions">
        <button
          type="submit"
          class="btn btn-filter"
          [disabled]="isFiltering"
        >
          <span *ngIf="!isFiltering">ğŸ” Appliquer les filtres</span>
          <span *ngIf="isFiltering">â³ Filtrage...</span>
        </button>

        <button
          type="button"
          class="btn btn-secondary"
          (click)="resetFilters()"
          [disabled]="isFiltering"
        >
          ğŸ—‘ï¸ Effacer les filtres
        </button>

        <!-- Bouton Export Excel -->
        <button
          type="button"
          class="btn btn-excel"
          (click)="exportToExcel()"
          [disabled]="filteredSaisies.length === 0"
        >
          ğŸ“Š Exporter en Excel
        </button>

        <!-- Indicateur de filtrage -->
        <div class="filter-info" *ngIf="isFiltered">
          <span class="badge badge-info">
            {{ filteredSaisies.length }} / {{ totalSaisiesCount }} rÃ©sultats
          </span>
          <small class="filter-text">Filtres actifs</small>
        </div>
      </div>
    </form>
  </div>

  <!-- ============ LISTE DES SAISIES ============ -->
  <div class="saisies-list">
    <div class="list-header">
      <h3>ğŸ“‹ Liste des Non-ConformitÃ©s 
        <span *ngIf="isFiltered">({{ filteredSaisies.length }} sur {{ totalSaisiesCount }})</span>
        <span *ngIf="!isFiltered">({{ totalSaisiesCount }})</span>
      </h3>
      
      <!-- Bouton d'export en bas aussi -->
      <button
        *ngIf="saisies.length > 0"
        class="btn btn-excel-bottom"
        (click)="exportToExcel()"
        [disabled]="filteredSaisies.length === 0"
      >
         TÃ©lÃ©charger Excel
      </button>
    </div>
    
    <div class="table-container" *ngIf="filteredSaisies.length > 0">
      <table class="saisies-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Source</th>
            <th>Type Interne</th>
            <th>Ligne</th>
            <th>RÃ©fÃ©rence</th>
            <th>Type</th>
            <th>QtÃ© Rebut</th>
            <th>Sortie Ligne</th>
            <th>DÃ©fauts</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let saisie of filteredSaisies">
            <td>{{ saisie.date | date: 'dd/MM/yyyy' }}</td>
            <td>
              <span class="badge" 
                    [class.badge-fournisseur]="saisie.sourceType === 'fournisseur'" 
                    [class.badge-interne]="saisie.sourceType === 'interne'">
                {{ saisie.sourceType === 'fournisseur' ? 'Fournisseur' : 'Interne' }}
              </span>
            </td>
            <td>
              <span *ngIf="saisie.typeInterne" class="badge badge-type-interne">
                {{ saisie.typeInterne }}
              </span>
              <span *ngIf="!saisie.typeInterne" class="badge badge-none">-</span>
            </td>
            <td><span class="badge badge-ligne">{{ saisie.ligne }}</span></td>
            <td>{{ saisie.reference }}</td>
            <td>
              <span class="badge" [class.badge-mp]="saisie.type === 'MP'" [class.badge-se]="saisie.type === 'SE'">
                {{ saisie.type }}
              </span>
            </td>
            <td class="text-center">{{ saisie.qteRebut }}</td>
            <td class="text-center">{{ saisie.sortieLigne }}</td>
            
            <!-- Colonne DÃ©fauts -->
            <td>{{ saisie.defauts }}</td>
            
            <!-- Colonne Statut -->
            <td>
              <span class="badge" 
                    [class.badge-en-attente]="saisie.statut === 'en attente'"
                    [class.badge-declare]="saisie.statut === 'dÃ©clarÃ©'">
                {{ saisie.statut }}
              </span>
            </td>
            
            <!-- Colonne Actions -->
            <td class="actions-cell">
              <!-- Bouton D rouge seulement si statut = "en attente" -->
              <button
                *ngIf="saisie.statut === 'en attente'"
                class="btn-icon btn-statut-d"
                (click)="updateStatutToDeclare(saisie)"
                title="Marquer comme dÃ©clarÃ© (D)"
              >
                ğŸ”´ D
              </button>
              
              <!-- Bouton Supprimer -->
              <button
                class="btn-icon btn-delete"
                (click)="deleteSaisie(saisie.id!)"
                title="Supprimer"
              >
                ğŸ—‘ï¸
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Message si aucun rÃ©sultat aprÃ¨s filtrage -->
    <div *ngIf="filteredSaisies.length === 0 && saisies.length > 0" class="empty-filtered">
      <p>ğŸ” Aucune saisie ne correspond Ã  vos critÃ¨res de filtrage</p>
      <button class="btn btn-link" (click)="resetFilters()">
        Afficher toutes les saisies ({{ totalSaisiesCount }})
      </button>
    </div>

    <!-- Message si aucune saisie du tout -->
    <div *ngIf="saisies.length === 0 && !isLoading" class="empty-state">
      <p>ğŸ“­ Aucune saisie de non-conformitÃ© pour le moment</p>
    </div>

    <!-- Loading spinner -->
    <div *ngIf="isLoading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Chargement en cours...</p>
    </div>
  </div>
</div>